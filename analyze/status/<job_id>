# in your main flask app.py
from .tasks import run_clarity_analysis # Ensure this is imported

@app.route('/analyze/status/<job_id>', methods=['GET'])
def get_analysis_status(job_id):
    """
    Returns the current status of an analysis job.
    If complete, it also returns the final result.
    """
    task = run_clarity_analysis.AsyncResult(job_id)

    if task.state == 'PENDING':
        response = {'state': task.state, 'status': 'Pending...'}
    elif task.state != 'FAILURE':
        response = {'state': task.state, 'status': 'Processing...'}
        if task.state == 'SUCCESS':
            # Job is complete! Include the final result.
            response['status'] = 'Complete'
            response['result'] = task.info.get('result')
    else: # Handle failure
        response = {
            'state': task.state,
            'status': str(task.info), # This will contain the error message
        }
    
    return jsonify(response)
