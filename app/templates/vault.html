{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white">
    <!-- Navigation Header -->
    <nav class="bg-gray-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-white">Intelligence Vault</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('main.dashboard') }}" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                        Dashboard
                    </a>
                    <a href="{{ url_for('main.analysis') }}" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        New Analysis
                    </a>
                    <a href="{{ url_for('auth.logout') }}" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                    <div class="bg-green-600 text-white px-4 py-3 rounded-md mb-2">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% endwith %}

        <!-- Vault Management Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Document Upload Section -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Upload Documents</h2>
                <p class="text-gray-300 mb-4">Add documents to your Intelligence Vault for persistent AI memory.</p>
                
                <form id="uploadForm" enctype="multipart/form-data" class="space-y-4">
                    <div>
                        <label for="files" class="block text-sm font-medium text-gray-300 mb-2">
                            Select Files
                        </label>
                        <input type="file" id="files" name="files" multiple 
                               accept=".pdf,.docx,.doc,.txt" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-400 mt-1">Supported formats: PDF, DOCX, DOC, TXT</p>
                    </div>
                    
                    <div>
                        <label for="source" class="block text-sm font-medium text-gray-300 mb-2">
                            Source (Optional)
                        </label>
                        <input type="text" id="source" name="source" 
                               placeholder="e.g., Legal Documents, Research Papers"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button type="submit" id="uploadBtn" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium transition-colors flex items-center justify-center">
                        <i class="fas fa-upload mr-2"></i>
                        Upload & Index Documents
                    </button>
                </form>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-4 hidden">
                    <div class="bg-gray-700 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-sm text-gray-300 mt-2">Uploading...</p>
                </div>
            </div>

            <!-- Vault Statistics Section -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Vault Statistics</h2>
                <div id="vaultStats" class="space-y-4">
                    <div class="text-center text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading vault statistics...</p>
                    </div>
                </div>
                
                <div class="mt-6 space-y-3">
                    <button onclick="refreshStats()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Refresh Stats
                    </button>
                    <button onclick="searchVault()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Search Vault
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Results Section -->
        <div id="searchResults" class="mt-6 hidden">
            <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Search Results</h3>
                <div id="searchContent" class="space-y-4">
                    <!-- Search results will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="mt-6">
            <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Recent Activity</h3>
                <div id="recentActivity" class="space-y-3">
                    <div class="text-center text-gray-400">
                        <p>No recent activity to display</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
    // Get API key for requests
    function getApiKey() {
        // This would normally come from the user's session or a secure storage
        // For now, we'll prompt the user to enter it
        const apiKey = localStorage.getItem('clarity_api_key');
        if (!apiKey) {
            const key = prompt('Please enter your API key to use the vault:');
            if (key) {
                localStorage.setItem('clarity_api_key', key);
                return key;
            }
            return null;
        }
        return apiKey;
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
        toast.className = `${bgColor} text-white px-6 py-3 rounded-md shadow-lg flex items-center justify-between min-w-80`;
        toast.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        `;
        document.getElementById('toastContainer').appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    // Upload form handler
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const files = document.getElementById('files').files;
        const source = document.getElementById('source').value || 'unknown';
        
        if (files.length === 0) {
            showToast('Please select at least one file to upload', 'error');
            return;
        }

        const apiKey = getApiKey();
        if (!apiKey) {
            showToast('API key required for vault operations', 'error');
            return;
        }

        // Show progress
        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const uploadBtn = document.getElementById('uploadBtn');
        
        progressDiv.classList.remove('hidden');
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

        // Prepare form data
        const formData = new FormData();
        for (let file of files) {
            formData.append('files', file);
        }
        formData.append('source', source);

        try {
            const response = await fetch('/vault/add', {
                method: 'POST',
                headers: {
                    'X-API-KEY': apiKey
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Successfully queued ${data.document_count} files for indexing`, 'success');
                progressText.textContent = `Job ID: ${data.job_id}`;
                
                // Poll for completion
                pollJobStatus(data.job_id);
            } else {
                showToast('Upload failed: ' + data.error, 'error');
                progressDiv.classList.add('hidden');
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload & Index Documents';
            }
        } catch (error) {
            console.error('Upload error:', error);
            showToast('Upload failed: ' + error.message, 'error');
            progressDiv.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload & Index Documents';
        }
    });

    // Poll job status
    async function pollJobStatus(jobId) {
        const apiKey = getApiKey();
        if (!apiKey) return;

        try {
            const response = await fetch(`/vault/status/${jobId}`, {
                headers: {
                    'X-API-KEY': apiKey
                }
            });
            const data = await response.json();

            if (data.state === 'SUCCESS') {
                showToast('Documents indexed successfully!', 'success');
                document.getElementById('uploadProgress').classList.add('hidden');
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload mr-2"></i>Upload & Index Documents';
                refreshStats();
            } else if (data.state === 'FAILURE') {
                showToast('Indexing failed: ' + data.error, 'error');
                document.getElementById('uploadProgress').classList.add('hidden');
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload mr-2"></i>Upload & Index Documents';
            } else {
                // Still processing, check again in 2 seconds
                setTimeout(() => pollJobStatus(jobId), 2000);
            }
        } catch (error) {
            console.error('Status check error:', error);
            setTimeout(() => pollJobStatus(jobId), 2000);
        }
    }

    // Refresh vault statistics
    async function refreshStats() {
        const apiKey = getApiKey();
        if (!apiKey) {
            showToast('API key required for vault operations', 'error');
            return;
        }

        try {
            const response = await fetch('/vault/stats', {
                headers: {
                    'X-API-KEY': apiKey
                }
            });
            const data = await response.json();

            if (data.success) {
                const stats = data.vault_stats;
                document.getElementById('vaultStats').innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-400">${stats.document_count}</div>
                            <div class="text-sm text-gray-300">Documents</div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-400">${stats.collection_name}</div>
                            <div class="text-sm text-gray-300">Collection</div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('vaultStats').innerHTML = `
                    <div class="text-red-400 text-center">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Error: ${data.error}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Stats error:', error);
            document.getElementById('vaultStats').innerHTML = `
                <div class="text-red-400 text-center">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Failed to load statistics</p>
                </div>
            `;
        }
    }

    // Search vault
    async function searchVault() {
        const query = prompt('Enter search query:');
        if (!query) return;

        const apiKey = getApiKey();
        if (!apiKey) {
            showToast('API key required for vault operations', 'error');
            return;
        }

        try {
            const response = await fetch('/vault/search', {
                method: 'POST',
                headers: {
                    'X-API-KEY': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    n_results: 5
                })
            });
            const data = await response.json();

            if (data.success) {
                displaySearchResults(data);
            } else {
                showToast('Search failed: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Search error:', error);
            showToast('Search failed: ' + error.message, 'error');
        }
    }

    // Display search results
    function displaySearchResults(data) {
        const resultsDiv = document.getElementById('searchResults');
        const contentDiv = document.getElementById('searchContent');
        
        if (data.documents.length === 0) {
            contentDiv.innerHTML = '<div class="text-gray-400 text-center">No results found</div>';
        } else {
            let html = '';
            data.documents.forEach((doc, index) => {
                const metadata = data.metadatas[index] || {};
                const distance = data.distances[index] || 0;
                const similarity = Math.round((1 - distance) * 100);
                
                html += `
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-sm text-gray-400">
                                ${metadata.filename || 'Unknown'} â€¢ ${similarity}% similar
                            </div>
                            <div class="text-xs text-gray-500">
                                Chunk ${metadata.chunk_index + 1}/${metadata.total_chunks}
                            </div>
                        </div>
                        <div class="text-gray-200 text-sm">
                            ${doc.substring(0, 200)}${doc.length > 200 ? '...' : ''}
                        </div>
                    </div>
                `;
            });
            contentDiv.innerHTML = html;
        }
        
        resultsDiv.classList.remove('hidden');
    }

    // Load stats on page load
    document.addEventListener('DOMContentLoaded', function() {
        refreshStats();
    });
</script>
{% endblock %}
